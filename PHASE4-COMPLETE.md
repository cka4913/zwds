# Phase 4 完成：大限和流年计算

## 概述

Phase 4 已完成大限（Major Periods）和流年（Annual Periods）的计算功能。

## 实现内容

### 1. 新增文件

**`packages/core/src/fortune.ts`** - 大限和流年计算模块
- `getStartingAge()` - 根据五行局确定起始年龄
- `isYangDirection()` - 判断阴阳男女的顺逆方向
- `calculateDecades()` - 计算各宫的大限年份范围
- `getAnnualPalace()` - 计算给定年份对应的流年宫位
- `getAnnualYearsForPalace()` - 生成流年年份列表
- `formatDecadeRange()` - 格式化大限年份

### 2. 核心算法

#### 大限计算规则

**起始年龄**：
- 水二局：2岁起
- 木三局：3岁起
- 金四局：4岁起
- 土五局：5岁起
- 火六局：6岁起

**阴阳男女顺逆规则**：
- **阳男阴女顺行**：从命宫开始，逆着宫位顺序走（命→父→福→田→官→仆→迁→疾→财→子→夫→兄）
- **阴男阳女逆行**：从命宫开始，顺着宫位顺序走（命→兄→夫→子→财→疾→迁→仆→官→田→福→父）

**大限周期**：
- 每个大限为10年
- 共12个大限周期（120年）

#### 流年计算规则

流年按照与大限相同的方向，从命宫开始，每年移动一个宫位：
- 阳男阴女：顺时针（逆着宫位顺序）
- 阴男阳女：逆时针（顺着宫位顺序）

每个宫位对应的流年年份按12年一周期循环。

### 3. 数据结构

#### DecadeRange
```typescript
interface DecadeRange {
  start: number;  // 起始年龄
  end: number;    // 结束年龄
}
```

#### PalaceSlot 扩展
```typescript
interface PalaceSlot {
  // ... 其他字段
  decadeYears?: [number, number];  // 大限年份范围 [起始年份, 结束年份]
  flowYears?: number[];            // 流年年份列表
}
```

### 4. 集成到 makeChart()

在 `packages/core/src/index.ts` 中：
1. 计算各宫的大限年份范围
2. 计算各宫的流年年份（最多120年，显示前10个）
3. 将结果添加到每个宫位的数据中

### 5. 文本渲染更新

在 `renderText()` 中：
- 显示大限年份：`大限年份：YYYY-YYYY`
- 显示流年年份：`流年年份：YYYY,YYYY,...<如此類推>....`（前10个）

## 验证结果

### 案例1: 1984-09-19 女命（土五局，阳女）
- 五行局：土五局 → 5岁起
- 阳女 → 逆行（顺着宫位顺序）
- 命宫大限：1988-1997（5-14岁）✓
- 兄弟宫大限：1998-2007（15-24岁）✓
- 流年：1984, 1996, 2008, 2020...（每12年循环）✓

### 案例2: 1975-10-23 男命（金四局，阴男）
- 五行局：金四局 → 4岁起
- 阴男 → 逆行（顺着宫位顺序）
- 命宫大限：1978-1987（4-13岁）✓
- 兄弟宫大限：1988-1997（14-23岁）✓
- 夫妻宫大限：1998-2007（24-33岁）✓
- 流年：1975, 1987, 1999, 2011...（每12年循环）✓

### 案例3: 1976-10-16 男命（木三局，阳男）
- 五行局：木三局 → 3岁起
- 阳男 → 顺行（逆着宫位顺序）
- 命宫大限：1978-1987（3-12岁）✓
- 父母宫大限：1988-1997（13-22岁）✓
- 福德宫大限：1998-2007（23-32岁）✓
- 田宅宫大限：2008-2017（33-42岁）✓
- 兄弟宫大限：2088-2097（113-122岁，第12个大限）✓
- 流年：1976, 1988, 2000, 2012...（每12年循环）✓

## 重要修正

### 宫位排列 vs 大限顺序

在实现过程中发现并修正了一个重要概念：

1. **宫位排列**：固定逆时针排列（命→兄→夫→子→财→疾→迁→仆→官→田→福→父）
2. **大限顺序**：根据阴阳男女决定
   - 阳男阴女：逆着宫位顺序（命→父→福→田...）
   - 阴男阳女：顺着宫位顺序（命→兄→夫→子...）

**关键发现**：
- 阴阳男女规则**不影响宫位排列**，只影响大限和流年的顺序
- 宫位一律从命宫逆时针排列（在 Phase 3 中已修正）
- 大限和流年才使用阴阳男女的顺逆规则

## 测试脚本

创建了 `test-fortune.sh` 用于测试大限和流年功能：
```bash
chmod +x test-fortune.sh
./test-fortune.sh
```

## 输出示例

```
性別：男
陽曆生日：1976 年 10 月 16 日 22 時
農曆生日：1976 年 8 月 23 日 亥 時
命局：木三局，陽男

【命宮：宮位在戊戌】
大限年份：1978-1987
流年年份：1976,1988,2000,2012,2024,2036,2048,2060,2072,2084....<如此類推>....
主星有：貪狼廟
輔星有：地劫平
四化：
．命宮戊干飛入命宮貪狼化祿
．疾厄宮癸干飛入命宮貪狼化忌
．父母宮己干飛入命宮貪狼化權
```

## 文件清单

### 新增
- `packages/core/src/fortune.ts` - 大限和流年计算模块
- `test-fortune.sh` - 大限和流年测试脚本
- `PHASE4-COMPLETE.md` - 本文档

### 修改
- `packages/core/src/index.ts` - 集成大限和流年计算
- `packages/core/src/types.ts` - PalaceSlot 已包含 decadeYears 和 flowYears 字段

## 下一步

✅ Phase 0: 数据表建立
✅ Phase 1: 核心工具实现
✅ Phase 2: 14主星安星
✅ Phase 3: 辅星和四化
✅ **Phase 4: 大限和流年** ← 当前完成
⬜ Phase 5: 文本渲染优化
⬜ Phase 6: 搜索引擎
⬜ Phase 7: 集成和优化

## 总结

Phase 4 成功实现了大限和流年的完整计算功能，包括：
- ✓ 根据五行局确定起始年龄
- ✓ 阴阳男女顺逆规则
- ✓ 12个大限周期的年份计算
- ✓ 流年宫位和年份计算
- ✓ 文本渲染集成
- ✓ 全部测试用例通过

所有功能已验证正确，可以继续下一阶段的开发。
