# 四化显示说明

## 概述

四化显示采用**三分法**，将四化分为三个部分：
1. **生年四化**：根据出生年的天干产生的四化
2. **宫位四化**：当前宫位的天干产生的四化（飞向其他宫位）
3. **飞入四化**：其他宫位的天干产生的四化（飞入当前宫位）

## 显示格式

### 完整示例

```
四化：
生年四化：
．生年四化乙干天機化祿
．生年四化乙干天梁化權
宫位四化：
．命宮庚干飛入夫妻宮太陽化祿
．命宮庚干飛入子女宮武曲化權
．命宮庚干飛入財帛宮太陰化科
．命宮庚干飛入財帛宮天同化忌
飞入四化：
．兄弟宮己干飛入命宮天梁化科
．夫妻宮戊干飛入命宮天機化忌
．子女宮己干飛入命宮天梁化科
```

### 自化标注

当宫位的四化飞入自己时，会标注"（自化X）"：

```
宫位四化：
．財帛宮戊干飛入財帛宮太陰化權（自權）
```

### 无四化情况

如果某个部分没有四化，则不显示该部分：

```
四化：
宫位四化：
．命宮庚干飛入財帛宮太陽化祿
．命宮庚干飛入疾厄宮武曲化權
```
（此例中没有生年四化飞入命宫，也没有其他宫位飞入，所以只显示宫位四化）

如果三个部分都没有：
```
四化：
．（無）
```

## 三分法详解

### 1. 生年四化

**定义**：根据出生年的天干（年干），产生四化，飞入当前宫位。

**特点**：
- 每个人固定，由出生年决定
- 例如：1975年是乙卯年，年干为"乙"
- 乙干产生：天机化禄、天梁化权、紫微化科、太阴化忌

**显示**：只显示飞入**当前宫位**的生年四化

```
生年四化：
．生年四化乙干天機化祿  ← 天机星在命宫，所以显示
．生年四化乙干天梁化權  ← 天梁星在命宫，所以显示
```

### 2. 宫位四化

**定义**：当前宫位的天干产生的四化，飞向所有宫位（包括自己）。

**特点**：
- 显示当前宫位"发射"的四化
- 如果飞入自己，标注"（自化X）"
- 例如：命宫天干为"庚"，庚干产生四化飞向其他宫位

**显示**：显示从**当前宫位飞出**的所有四化

```
宫位四化：
．命宮庚干飛入夫妻宮太陽化祿  ← 命宫庚干让夫妻宫的太阳化禄
．命宮庚干飛入子女宮武曲化權  ← 命宫庚干让子女宫的武曲化权
．財帛宮戊干飛入財帛宮太陰化權（自權）  ← 自化
```

### 3. 飞入四化

**定义**：其他宫位的天干产生的四化，飞入当前宫位。

**特点**：
- 显示其他宫位"发射"到当前宫位的四化
- 不包括自化（自化在"宫位四化"中显示）
- 不包括生年四化（生年四化单独显示）

**显示**：显示从**其他宫位飞入**当前宫位的四化

```
飞入四化：
．兄弟宮己干飛入命宮天梁化科  ← 兄弟宫己干让命宫的天梁化科
．夫妻宮戊干飛入命宮天機化忌  ← 夫妻宫戊干让命宫的天机化忌
```

## 实际案例

### 案例1：1975-10-23 男命 命宫

**出生年**：1975年（乙卯年）
**命宫天干**：庚辰（庚干）

```
四化：
生年四化：
．生年四化乙干天機化祿  ← 乙干（生年）让命宫的天机化禄
．生年四化乙干天梁化權  ← 乙干（生年）让命宫的天梁化权
宫位四化：
．命宮庚干飛入夫妻宮太陽化祿  ← 命宫庚干影响夫妻宫
．命宮庚干飛入子女宮武曲化權  ← 命宫庚干影响子女宫
．命宮庚干飛入財帛宮太陰化科  ← 命宫庚干影响财帛宫
．命宮庚干飛入財帛宮天同化忌  ← 命宫庚干影响财帛宫
飞入四化：
．兄弟宮己干飛入命宮天梁化科  ← 兄弟宫影响命宫
．夫妻宮戊干飛入命宮天機化忌  ← 夫妻宫影响命宫
... （其他宫位飞入）
```

### 案例2：1975-10-23 男命 财帛宫（有自化）

**财帛宫天干**：戊子（戊干）

```
四化：
生年四化：
．生年四化乙干太陰化忌  ← 生年四化飞入财帛宫
宫位四化：
．財帛宮戊干飛入命宮天機化忌  ← 财帛宫影响命宫
．財帛宮戊干飛入夫妻宮右弼化科  ← 财帛宫影响夫妻宫
．財帛宮戊干飛入子女宮貪狼化祿  ← 财帛宫影响子女宫
．財帛宮戊干飛入財帛宮太陰化權（自權）  ← 自化！
飞入四化：
．命宮庚干飛入財帛宮太陰化科  ← 命宫影响财帛宫
．命宮庚干飛入財帛宮天同化忌  ← 命宫影响财帛宫
... （其他宫位飞入）
```

**解释**：
- 财帛宫戊干让财帛宫的太阴化权，这是**自化权**
- 自化表示宫位对自己的影响

### 案例3：1984-09-19 女命 命宫（无生年四化）

**出生年**：1984年（甲子年）
**命宫天干**：庚午（庚干）
**命宫星曜**：无主星

```
四化：
宫位四化：
．命宮庚干飛入財帛宮太陽化祿
．命宮庚干飛入疾厄宮武曲化權
．命宮庚干飛入遷移宮太陰化科
．命宮庚干飛入遷移宮天同化忌
```

**解释**：
- 命宫没有主星，所以没有生年四化飞入
- 其他宫位也没有四化飞入命宫
- 只有命宫自己的四化飞向其他宫位

## 优势

### 1. 清晰分类
- 一目了然地看出三种四化的来源
- 生年四化（先天）、宫位四化（本宫发射）、飞入四化（受他宫影响）

### 2. 自化标注
- 明确标注自化情况
- 便于分析宫位的自我影响

### 3. 按需显示
- 如果某部分没有四化，不显示该部分
- 避免冗余信息

### 4. 完整性
- 显示所有与当前宫位相关的四化
- 既显示本宫发出的，也显示飞入的

## 技术实现

### 数据结构

```typescript
interface TransformResult {
  from: PalaceName;           // 发射宫
  to: PalaceName;             // 目的宫
  star: string;               // 星曜名称
  type: Transform;            // 化禄/化权/化科/化忌
  isYearTransform?: boolean;  // 是否为生年四化
  yearStem?: HeavenlyStem;    // 如果是生年四化，记录年干
}
```

### 显示逻辑

```typescript
// 1. 生年四化：筛选 isYearTransform === true 且飞入当前宫位
const yearTransforms = palace.transforms.filter(t => t.isYearTransform);

// 2. 宫位四化：遍历所有宫位，找出 from === 当前宫位 的四化
const outgoingTransforms = []; // 从当前宫位发出
for (const targetPalace of allPalaces) {
  for (const t of targetPalace.transforms) {
    if (t.from === currentPalace) {
      outgoingTransforms.push(t);
      // 检查自化
      if (t.from === t.to) {
        t.selfNote = `（自${t.type.slice(1)}）`;
      }
    }
  }
}

// 3. 飞入四化：筛选 isYearTransform === false 且 from !== to
const incomingTransforms = palace.transforms.filter(
  t => !t.isYearTransform && t.from !== t.to
);
```

## 测试验证

运行测试脚本：
```bash
./test-transforms-new.sh
```

测试内容：
- ✓ 三分法显示正确
- ✓ 生年四化、宫位四化、飞入四化分别显示
- ✓ 自化标注正常工作
- ✓ 空白情况处理正确

## 总结

新的四化显示格式：
1. **更清晰**：三分法一目了然
2. **更完整**：显示所有相关四化
3. **更专业**：符合紫微斗数的分析习惯
4. **更易用**：自化标注和智能隐藏
